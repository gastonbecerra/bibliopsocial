---
title: "Untitled"
author: "gaston becerra"
date: "2023-05-29"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    fig_caption: yes
  word_document: default
    # always_allow_html: true
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(igraph)
library(ggraph)
library(tidygraph)
library(wordcloud)
library(RColorBrewer)
library(wordcloud2)
library(scales)
library(readxl)
library(googlesheets4)

```


```{r carga, echo=FALSE, message=FALSE, warning=FALSE}



googlesheets4::gs4_deauth()

articles <- googlesheets4::read_sheet('1h8YDxHjcBqQf5vOIao9rbJezLbVDJSDBclEjzPQlEHU', sheet = 'data')

autores <- googlesheets4::read_sheet('1h8YDxHjcBqQf5vOIao9rbJezLbVDJSDBclEjzPQlEHU', sheet = 'autores')
glimpse(autores)

variables <- googlesheets4::read_sheet('1h8YDxHjcBqQf5vOIao9rbJezLbVDJSDBclEjzPQlEHU', sheet = 'variables')
glimpse(variables)

escalas <- googlesheets4::read_sheet('1h8YDxHjcBqQf5vOIao9rbJezLbVDJSDBclEjzPQlEHU', sheet = 'empíricos')
glimpse(escalas)

```

## Producción

Artículos por año

```{r}

articles %>% count(ano) %>% 
  ggplot(aes(x=ano,y=n)) + # , color=source
  geom_line() + 
  geom_point() +
  geom_label(aes(label=n)) +
  theme_minimal() +
  scale_x_continuous(name="anos", 
                     minor_breaks = NULL) +
  #scale_y_continuous(name="Number of Publications") + 
  #scale_y_continuous(label = scales::label_number(accuracy = 1))+
  scale_y_discrete()+
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

```

articulos por año x tema

```{r}

articles %>% count(ano, tema) %>% 
  ggplot(aes(x=ano,y=n, fill = tema)) + # , color=source
  geom_col() + 
  coord_flip() +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

```


articulos por tema x año

```{r}

articles %>% count(ano, tema) %>% 
  ggplot(aes(x=tema,y=ano, fill = n)) + # , color=source
  geom_tile() +
  coord_flip() +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
      
```


## autores y universidades

cuantos autores publican por año por universidad (se cuenta 1 paper para cada autor) ... este dato no es muy util. tal vez si fuera cantidad de papers por universidad (no por autor)

```{r tiempo2, echo=FALSE, fig.height=4, fig.width=8}

autores %>% 
  count(sigla, ano, sort = TRUE) %>% 
  group_by(sigla) %>% mutate(
    total_papers=sum(n),
    anios=n()
    ) %>% 
  ungroup() %>%
  filter(!is.na(sigla)) %>%
    ggplot(aes(x=ano,y=reorder(sigla,total_papers),fill=n)) + 
      geom_tile() +
      geom_text(aes(label=n), color="white", show.legend = FALSE, size=3) +
      theme_minimal() +
      scale_x_continuous(name="", 
                     minor_breaks = NULL) +
  scale_fill_gradient(low="lightblue", high="red") +
  theme(axis.title.y=element_blank()) +
  theme(plot.caption = element_text(hjust=0.5, size=rel(1))) +
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

```


colaboracion entre autores


```{r autores, fig.height=9, fig.width=9}

autores %>% 
  widyr::pairwise_count(item = autor, feature = id) %>%
  tidygraph::as_tbl_graph(.,
  directed = FALSE) %>%
    activate(nodes) %>%
    left_join( autores %>% count(autor, name = "articulos"), by = c("name"="autor")) %>%
  ggraph::ggraph(layout='fr') +
    geom_edge_link()+
    geom_node_point(aes(size=articulos))+
    geom_node_text(aes(label = name), repel = TRUE) +
    theme_graph()


```

colaboracion entre universidades

- el tamaño de la bola es la cantidad de articulos (contando a cada autor por separado)
- el grosor de las lineas el grado de colaboraciones (contando a cada autor por separado)

```{r, fig.height=7}

autores %>% 
  widyr::pairwise_count(item = sigla, feature = id, sort = TRUE) %>%
  tidygraph::as_tbl_graph(.,
  directed = FALSE) %>%
  activate(nodes) %>% 
  inner_join( autores %>%
              count(sigla, name = "art_totales") 
              , by=c("name"="sigla") ) %>%
  create_layout( layout = "kk") %>%
  ggraph::ggraph(layout) +
  geom_edge_link(aes(edge_width = n)  )+
  geom_node_point(aes(size = art_totales)) +
  geom_node_text(aes(label = toupper(name) ), repel = TRUE) +
  theme_graph() +
  theme(legend.position = "none")

```


## keywords

```{r}

key <- articles %>% 
  separate_longer_delim(keywords, delim = ",") %>%
  count(keywords) %>% 
  filter(!is.na(n), !is.na(keywords))

```

```{r key1, eval=FALSE, include=FALSE}

key %>% ggplot(aes(y=(keywords), x=n)) +
  geom_col() + 
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())

```

```{r wordcloud}

# library(webshot)
# library(htmlwidgets)
# mygraph <- wordcloud2(data = key, size = .5)
# saveWidget(mygraph, "tmp.html", selfcontained = F)
# webshot("tmp.html", "wc1.png", delay = 5, vwidth = 900, vheight = 700)

library(ggwordcloud)

key %>% ggplot(aes(label=keywords, size=n)) +
  geom_text_wordcloud() + 
  theme_minimal()

```

(este grafico hay que chequearlo. creo que con los N de cada keyword piso la relacion!)

```{r key2, fig.height=7}


articles %>% 
  separate_longer_delim(keywords, delim = ",") %>%
  widyr::pairwise_count(item = keywords, feature = id, sort = TRUE) %>%
  tidygraph::as_tbl_graph(.,
  directed = FALSE) %>%
  activate(nodes) %>% 
    left_join(key , by=c("name"="keywords") ) %>%
  create_layout( layout = "kk") %>%
  ggraph::ggraph(layout) +
  geom_edge_link(aes(edge_width = n) )+
  geom_node_text(aes(label = str_to_title(name) ), repel = TRUE) +
  theme_graph() +
  geom_node_point(aes(size = n)) +
  theme(legend.position = "none")

```



